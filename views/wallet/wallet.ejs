<%- include('../includes/head.ejs') -%>
<%- include('../includes/navigation.ejs') -%>

<%- include('../includes/header.ejs') -%>
<%- include('../components/searchbartr.ejs') -%>
<a href="/addwalletrecharge" class="btn btn-danger ml-3" type="button" aria-label="Add New">Wallet Recharge</a>

</div>
</div>
</div>
</div>
</div>
<div class="container-fluid mt--6">
    <div class="row">
      <div class="col">
        <div class="card">
            <!-- Card header -->
            <div class="card-header border-0 mb-2">
              <h3 class="mb-0 text-white">Wallet Status Check</h3>
            </div>
            <!-- Light table -->
            <div class="table-responsive">
              <table class="table align-items-center table-flush" id="rechargeTable">
                <thead class="thead-light">
                  <tr>
                    <th scope="col" class="sort" data-sort="name">Reacharge ID</th>

                    <th scope="col" class="sort" data-sort="name">Customer ID</th>
                    <th scope="col" class="sort" data-sort="status">Amount</th>
                    <th scope="col" class="sort">SalesMan ID</th>
                    <th scope="col" class="sort">Paid Coupons</th>
                    <th scope="col" class="sort">Free Coupons</th>
                    <th scope="col" class="sort">Total Coupons</th>
                    <th scope="col" class="sort" data-sort="completion">Created at</th>
                    <th scope="col" class="sort">Updated On</th>
                    <th scope="col" class="sort">Actions</th>
                  </tr>
                </thead>
                <tbody class="list">
                  <tr>
                    
                  </tr>
                </tbody>
              </table>
            </div>
            <!-- Card footer -->
          </div>
          
          <!-- Coupons Modal - Redesigned -->
          <div class="modal fade" id="couponsModal" tabindex="-1" role="dialog" aria-labelledby="couponsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header bg-gradient-primary">
                  <h5 class="modal-title text-white" id="couponsModalLabel">
                    <i class="fas fa-ticket-alt mr-2"></i>Coupon Details
                  </h5>
                  <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body p-0">
                  <!-- Customer info card -->
                  <div class="card mb-0 border-0">
                    <div class="card-body pb-0">
                      <div class="row mb-3">
                        <div class="col-md-4">
                          <div class="d-flex align-items-center">
                            <div class="icon icon-shape bg-gradient-success rounded-circle text-white mr-3">
                              <i class="fas fa-user"></i>
                            </div>
                            <div>
                              <span class="text-sm text-muted">Customer ID</span>
                              <h5 class="mb-0" id="modalCustomerId">--</h5>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="d-flex align-items-center">
                            <div class="icon icon-shape bg-gradient-info rounded-circle text-white mr-3">
                              <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div>
                              <span class="text-sm text-muted">Total Amount</span>
                              <h5 class="mb-0" id="modalAmount">--</h5>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="d-flex align-items-center">
                            <div class="icon icon-shape bg-gradient-warning rounded-circle text-white mr-3">
                              <i class="fas fa-tags"></i>
                            </div>
                            <div>
                              <span class="text-sm text-muted">Total Coupons</span>
                              <h5 class="mb-0" id="modalTotalCoupons">--</h5>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Coupons summary cards -->
                      <div class="row mb-4">
                        <div class="col-md-6">
                          <div class="card bg-gradient-primary bg-opacity-25 shadow-sm">
                            <div class="card-body py-3">
                              <div class="row">
                                <div class="col-4 text-center">
                                  <div class="icon icon-shape bg-white rounded-circle text-primary shadow">
                                    <i class="fas fa-receipt"></i>
                                  </div>
                                </div>
                                <div class="col-8">
                                  <h5 class="text-white mb-0">Paid Coupons</h5>
                                  <p class="display-4 text-white font-weight-bold mb-0" id="modalPaidCoupons">0</p>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="card bg-gradient-success bg-opacity-25 shadow-sm">
                            <div class="card-body py-3">
                              <div class="row">
                                <div class="col-4 text-center">
                                  <div class="icon icon-shape bg-white rounded-circle text-success shadow">
                                    <i class="fas fa-gift"></i>
                                  </div>
                                </div>
                                <div class="col-8">
                                  <h5 class="text-white mb-0">Free Coupons</h5>
                                  <p class="display-4 text-white font-weight-bold mb-0" id="modalFreeCoupons">0</p>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Coupon table -->
                  <div class="table-responsive">
                    <table class="table align-items-center table-flush" id="couponsTable">
                      <thead class="thead-light">
                        <tr>
                          <th scope="col">Coupon ID</th>
                          <th scope="col">Amount</th>
                          <th scope="col">Type</th>
                          <th scope="col">Status</th>
                          <th scope="col">Created</th>
                          <th scope="col">Updated</th>
                        </tr>
                      </thead>
                      <tbody id="couponsTableBody">
                        <!-- Coupons will be loaded here -->
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary" id="exportCoupons">
                    <i class="fas fa-download mr-1"></i> Export Coupons
                  </button>
                </div>
              </div>
            </div>
          </div>
      </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>

<script>
  $(document).ready(function () {
    const rechargeTable = $('#rechargeTable').DataTable({
      processing: true,
      serverSide: true,
      ajax: {
        url: '/getrecharges',
        type: 'GET',
        dataSrc: 'data'
      },
      language: {
        paginate: {
          next: '<i class="fas fa-chevron-right"></i>',
          previous: '<i class="fas fa-chevron-left"></i>'
        },
        search: "_INPUT_",
        searchPlaceholder: "Search Customer...",
        lengthMenu: "Show _MENU_ trucks",
        info: "Showing _START_ to _END_ of _TOTAL_ trucks"
      },
      columns: [
      {
    data: 'rechargeId',
    render: function (data, type, row) {
      return data ? data : 'N/A'; // or 'â€”' or any placeholder text
    }
  },

        { data: 'customerId' },
        { data: 'amount' },
        { data: 'salesmanId' },
        { data: 'paidcoupons' },
        { data: 'freecoupons' },
        { data: 'totalCoupons' },
        { 
          data: 'createdAt',
          render: function (data) {
            return new Date(data).toLocaleString();
          }
        },
        { 
          data: 'updatedAt',
          render: function (data) {
            return new Date(data).toLocaleString();
          }
        },
        {
          data: null,
          orderable: false,
          render: function(data, type, row) {
            return `<button class="btn btn-action btn-view edit-zone view-coupons" data-id="${row._id}">
                       View Coupons
                    </button>`;
          }
        }
      ],
      createdRow: function(row, data, dataIndex) {
        $(row).attr('data-id', data._id);
      }
    });

    // Handle button click to show coupons
    $('#rechargeTable tbody').on('click', '.view-coupons', function(e) {
      e.preventDefault();
      const rechargeId = $(this).data('id');
      
      if (rechargeId) {
        fetchCoupons(rechargeId);

      }
    });

var downloadid = ''
    function fetchCoupons(rechargeId) {
      fetch(`/recharges/${rechargeId}/coupons`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            downloadid = rechargeId
            // Get the recharge details row data
            const rowData = rechargeTable.row($(`tr[data-id="${rechargeId}"]`)).data();
            
            // Update modal header info
            $('#modalCustomerId').text(rowData.customerId);
            $('#modalAmount').text(rowData.amount);
            $('#modalPaidCoupons').text(rowData.paidcoupons);
            $('#modalFreeCoupons').text(rowData.freecoupons);
            $('#modalTotalCoupons').text(rowData.totalCoupons);
            
            // Update coupons table
            populateCouponsModal(data.coupons);
            $('#couponsModal').modal('show');
          } else {
            alert('Error loading coupons: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to load coupons');
        });
    }

    function populateCouponsModal(coupons) {
      const tableBody = $('#couponsTableBody');
      tableBody.empty();
      
      if (coupons && coupons.length > 0) {
        coupons.forEach(coupon => {
          const statusClass = coupon.status === 'claimed' ? 'success' : 'warning';
          const typeClass = coupon.coupontype === 'paid' ? 'primary' : 'success';
          
          const row = `
            <tr>
              <td>
                <div class="d-flex align-items-center">
                  <div class="avatar avatar-sm bg-${typeClass} rounded-circle mr-3">
                    <i class="fas fa-${coupon.coupontype === 'paid' ? 'receipt' : 'gift'} text-white"></i>
                  </div>
                  <span>${coupon.couponid || 'N/A'}</span>
                </div>
              </td>
              <td>
                <span class="font-weight-bold">${coupon.couponamt || '0'}</span>
              </td>
              <td>
                <span class="badge badge-pill badge-${typeClass} text-uppercase">
                  ${coupon.coupontype || 'unknown'}
                </span>
              </td>
              <td>
                <span class="badge badge-pill badge-${statusClass} text-uppercase">
                  ${coupon.status || 'active'}
                </span>
              </td>
              <td>${new Date(coupon.created).toLocaleString()}</td>
              <td>${coupon.updated ? new Date(coupon.updated).toLocaleString() : 'N/A'}</td>
            </tr>
          `;
          tableBody.append(row);
        });
      } else {
        tableBody.append('<tr><td colspan="6" class="text-center py-4"><div class="alert alert-warning mb-0">No coupons found for this recharge</div></td></tr>');
      }
    }
    
    // Export coupons functionality (placeholder)
    var downloadid = ''; // Set this dynamically as needed

      $('#exportCoupons').on('click', function () {
          if (downloadid) {
              window.open(`/downloadcoupon/${downloadid}`, '_blank');
          } else {
              alert("Download ID is missing.");
          }
      });

  });
</script>

<%- include('../includes/footer.ejs') -%>
<%- include('../includes/end.ejs') -%>