<%- include('../includes/head.ejs') -%>
<%- include('../includes/navigation.ejs') -%>

<%- include('../includes/header.ejs') -%>
<%- include('../components/searchbartr.ejs') -%>
<style>
  /* Scoped styles for custom-nav-tabs */
  .custom-nav-tabs {
    display: flex;
    gap: 10px;
    /* Add space between tabs for clear distinction */
    padding: 0;
    margin: 0;
    list-style: none;
  }
  .tab-button {
              padding: 10px 15px;
              border: 1px solid #ccc;
              cursor: pointer;
              background: #e7e7e7;
              font-weight: bold;
              margin-right: 5px;
              transition: 0.3s;
            }
          
            .tab-button.active {
              background: #4d8da9;
              color: #ffffff;
            }
  .filter-container {
              margin-top: 10px;
              padding: 15px;
              border-radius: 8px;
              background-color: #fff;
          }
          .filter-btn {
              background-color: black;
              color: white;
              padding: 8px 16px;
              border: none;
              border-radius: 5px;
              font-size: 14px;
          }
          .date-filter {
              display: flex;
              gap: 10px;
              flex-wrap: wrap;
              margin-top: 10px;
          }
          .date-input {
              flex: 1;
              padding: 8px;
              border: 1px solid #ccc;
              border-radius: 5px;
              display: flex;
              align-items: center;
              background: white;
          }
          .date-input input {
              border: none;
              outline: none;
              flex: 1;
          }
          .date-input svg {
              width: 20px;
              height: 20px;
              margin-left: 8px;
          }
          .download-link {
              color: black;
              text-decoration: none;
              font-size: 14px;
          }
          @media (max-width: 600px) {
              .date-filter {
                  flex-direction: column;
              }
          }
</style>


</div>
</div>
</div>
</div>
</div>

<div class="container-fluid mt--6">
  <div class="row">
    <div class="col-xl-3 col-md-6">
      <div class="card card-stats">
        <!-- Card body -->
        <div class="card-body">
          <div class="row">
            <div class="col">
              <h5 class="card-title text-uppercase text-muted mb-0">Previous Stock</h5>
              <span class="h2 font-weight-bold mb-0" id="previousStock">0</span>
            </div>
            <div class="col-auto">
              <div class="icon icon-shape bg-gradient-info text-white rounded-circle shadow">
                <i class="fa-solid fa-cubes-stacked"></i>              </div>
            </div>
          </div>
    
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card card-stats">
        
        <!-- Card body -->
        <div class="card-body">
            
          <div class="row">
            <div class="col">
              <h5 class="card-title text-uppercase text-muted mb-0">Stock Inward</h5>
              <span class="h2 font-weight-bold mb-0" id="stockInward">0</span>
            </div>
            <div class="col-auto">
              <div class="icon icon-shape bg-gradient-primary text-white rounded-circle shadow">
                <i class="fa-solid fa-cash-register"></i>
                            </div>
            </div>
          </div>
        
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card card-stats">
        <!-- Card body -->
        <div class="card-body">
          <div class="row">
            <div class="col">
              <h5 class="card-title text-uppercase text-muted mb-0">Stock OutWard</h5>
              <span class="h2 font-weight-bold mb-0" id="stockOutward">0</span>
            </div>
            <div class="col-auto">
              <div class="icon icon-shape bg-gradient-orange text-white rounded-circle shadow">
                <i class="ni ni-delivery-fast" ></i>
            </div>
            </div>
          </div>
         
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card card-stats">
        <!-- Card body -->
        <div class="card-body">
          <div class="row">
            <div class="col">
              <h5 class="card-title text-uppercase text-muted mb-0">Damaged Items</h5>
              <span class="h2 font-weight-bold mb-0" id="damagedItems">0</span>
            </div>
            <div class="col-auto">
              <div class="icon icon-shape bg-gradient-green text-white rounded-circle shadow">
                <i class="fa-solid fa-circle-exclamation"></i>              </div>
            </div>
          </div>
         
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card card-stats">
        <!-- Card body -->
        <div class="card-body">
          <div class="row">
            <div class="col">
              <h5 class="card-title text-uppercase text-muted mb-0">Current Stock</h5>
              <span class="h2 font-weight-bold mb-0" id="currentStock">0</span>
            </div>
            <div class="col-auto">
              <div class="icon icon-shape bg-gradient-info text-white rounded-circle shadow">
                <i class="fa-solid fa-boxes-stacked"></i>    
                        </div>
            </div>
          </div>
    
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card card-stats">
        <!-- Card body -->
        <div class="card-body">
          <div class="row">
            <div class="col">
              <h5 class="card-title text-uppercase text-muted mb-0">Disposed Stock</h5>
              <span class="h2 font-weight-bold mb-0" id="disposedStock">0</span>
            </div>
            <div class="col-auto">
              <div class="icon icon-shape bg-gradient-danger text-white rounded-circle shadow">
                <i class="fa-solid fa-trash"></i>
                                 </div>
            </div>
          </div>
    
        </div>
      </div>
    </div>
 
  </div>
  <div class="row">
    <div class="col-12">
      <div class="filter-container">
          <div class="date-filter">
              <label class="date-input">
                  <span>From</span>
                  <input type="date" id="fromDate">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 11h10v2H7z"/></svg>
              </label>
              <label class="date-input">
                  <span>To</span>
                  <input type="date" id="toDate">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 11h10v2H7z"/></svg>
              </label>
          </div>
          <button class="filter-btn float-right" id="applyFilterBtn">Filter By</button>
      </div>
    </div>
    <div class="col">
      <div class="card">
       
        <br>
     
        <div class="table-responsive">
            <table id="stockTable" class="table align-items-center table-striped">
                <thead class="thead-dark">
                  <tr>
                    <th>Date</th>
                    <th>Truck ID</th>
                    <th>City</th>
                    <th>Product ID</th>
                    <th>Product Name</th>
                    <th>Quantity</th>
                    <th>Inward/Outward</th>
                    <th>Time</th>
                    <th>Item Type</th>
                    <th>Done By</th>
                    <!-- <th>City</th> -->
                  </tr>
                </thead>
                <tbody>
                  <!-- Dynamic data will be inserted here -->
                </tbody>
              </table>
        </div>
      </div>
    </div>
  </div>

<!-- Load jQuery first -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap4.min.js"></script>

<script>
    $(document).ready(function () {

      var datatable  = $('#stockTable').DataTable({
    serverSide: true,
    processing: true,
    ajax: {
        url: '/getStockhistory',
        data: function(d) {
          const now = new Date();
        
        // Set default to current day (00:00:00 to 23:59:59)
        let fromDate = $('#fromDate').val();
        let toDate = $('#toDate').val();
        
        if (!fromDate || !toDate) {
            const todayStart = new Date(now);
            todayStart.setHours(0, 0, 0, 0);
            
            const todayEnd = new Date(now);
            todayEnd.setHours(23, 59, 59, 999);
            
            fromDate = fromDate || todayStart.toISOString();
            toDate = toDate || todayEnd.toISOString();
        }
        
        return {
            ...d,
            fromDate: fromDate,
            toDate: toDate,
            city: $('#citySelect').val(),
            product: '<%=id%>'
        };
        }
    },
    columns: [
        { data: 'date', render: data => new Date(data).toLocaleDateString() },
        { data: 'truckId' },
        { data: 'city' },
        { data: 'productid' },
        { data: 'productname' },
        { data: 'quantity' },
        { data: 'inwardoutward' },
        { 
            data: 'time', 
            render: data => data ? 
                new Date(data).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 
                'N/A' 
        },
        { data: 'itemtype' },
        { data: 'doneby' }
    ],
    // Additional optimizations:
    deferRender: true,
    scrollY: 400,
    scrollCollapse: true,
    scroller: true
});
        $('#applyFilterBtn').click(function() {
            datatable.ajax.reload();
            updateDashboardStats(
            $('#fromDate').val(),
            $('#toDate').val(),
            $('#citySelect').val()
        );
        });
    });
  </script>

  <script>
    // Function to fetch and update dashboard stats
function updateDashboardStats(fromDate, toDate, city) {
    $.ajax({
        url: '/stockhistory-stats',
        method: 'GET',
        data: {
            fromDate: fromDate,
            toDate: toDate,
            city: city
        },
        success: function(response) {
            if (response.success) {
                const stats = response.data;
                console.log(response.data)
                
                // Update each card
                $('#previousStock').text(stats.previousStock);
$('#stockInward').text(stats.stockInward);
$('#stockOutward').text(stats.stockOutward);
$('#damagedItems').text(stats.damagedItems);
$('#currentStock').text(stats.currentStock);
$('#disposedStock').text(stats.disposedStock);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error fetching dashboard stats:', error);
        }
    });
}

// Call this function on page load and when filters change
$(document).ready(function() {
    // Set default dates (today)
    const today = new Date().toISOString().split('T')[0];
    $('#fromDate').val(today);
    $('#toDate').val(today);
    
    // Initial load
    updateDashboardStats(today, today, $('#citySelect').val());
    
    // Update when filters change
    // $('#applyFilterBtn').click(function() {
    //     updateDashboardStats(
    //         $('#fromDate').val(),
    //         $('#toDate').val(),
    //         $('#citySelect').val()
    //     );
    // });
});
  </script>
<%- include('../includes/footer.ejs') -%>

<%- include('../includes/end.ejs') -%>
